I.	Unzip files

#!/bin/bash
#PBS -q batch
#PBS -l nodes=1:ppn=8
#PBS -l walltime=5:00:00
#PBS -N control
#PBS -m ea
#PBS -j oe
#PBS -M c-adhikb@jax.org
cd /projects/laubenbacher-lab/Aspergillosis/bandita/18laubenbacher110718_001_run2_cp_bandita/
gunzip *.gz

II.	Run FastQC on Orginal files. 

#!/bin/bash
#PBS -q batch
#PBS -l nodes=1:ppn=8
#PBS -l walltime=30:00:00
#PBS -N fastqc
#PBS -l mem=50G
#PBS -m ea
#PBS -j oe
#PBS -M c-adhikb@jax.org
cd /projects/laubenbacher-lab/Aspergillosis/bandita
module load fastqc/0.11.5
for f in $(find . -name *.fastq); do fastqc $f; done

III.	Checked the quality of fastqc files using the FastQC manual. To look at all fastqc files at once. Use MultiQC. MultiQC combines all fastqc results together into 1 document. 

IV.	Trim files as necessary using trimmomatic. Below is example for run1, do the same for run 2. Trimmomatic adapter files uploaded in github as well. 

cd /projects/laubenbacher-lab/Aspergillosis/18laubenbacher112018_001
for r1 in M*_R1_001.fastq.gz ;do
SAMPLE=$(echo $r1 | cut -d "_" -f 1)
sname=${SAMPLE}_run1
r2=${r1/R1/R2}
echo "
#!/bin/bash
#PBS -q batch
#PBS -l nodes=1:ppn=1
#PBS -l walltime=8:00:00
#PBS -N trimrun1$(echo $r1 | cut -d "_" -f 1)
#PBS -l mem=25G
#PBS -m ea
#PBS -j oe
#PBS -e /projects/laubenbacher-lab/Aspergillosis/bandita/mac_may_analysis/runI/$(echo $r1 | cut -d "_" -f 1).err
#PBS -o /projects/laubenbacher-lab/Aspergillosis/bandita/mac_may_analysis/runI/$(echo $r1 | cut -d "_" -f 1).o 
#PBS -M badhikari@uchc.edu

module load java/1.8.0

cd /projects/laubenbacher-lab/Aspergillosis/bandita/mac_may_analysis/runI

  java -jar /opt/software/helix/trimmomatic/0.33/bin/trimmomatic.jar PE -trimlog /projects/laubenbacher-lab/Aspergillosis/bandita/mac_may_analysis/runI/trimrun1_${SAMPLE}.log /projects/laubenbacher-lab/Aspergillosis/18laubenbacher112018_001/$r1 /projects/laubenbacher-lab/Aspergillosis/18laubenbacher112018_001/$r2  /projects/laubenbacher-lab/Aspergillosis/bandita/mac_may_analysis/runI/${sname}_R1_trimmed_P.fq.gz /projects/laubenbacher-lab/Aspergillosis/bandita/mac_may_analysis/runI/${sname}_R1_trimmed_U.fq.gz /projects/laubenbacher-lab/Aspergillosis/bandita/mac_may_analysis/runI/${sname}_R2_trimmed_P.fq.gz /projects/laubenbacher-lab/Aspergillosis/bandita/mac_may_analysis/runI/${sname}_R2_trimmed_U.fq.gz LEADING:3 TRAILING:3 SLIDINGWINDOW:4:15 MINLEN:36 ILLUMINACLIP:/projects/laubenbacher-lab/Aspergillosis/bandita/mac_may_analysis/trimmomatic_PE_adapters.fa:2:30:10

exit
">/projects/laubenbacher-lab/Aspergillosis/bandita/mac_may_analysis/runI/trimrun1_$SAMPLE.sh

qsub /projects/laubenbacher-lab/Aspergillosis/bandita/mac_may_analysis/runI/trimrun1_$SAMPLE.sh

done
echo "jobs succesfully submitted"
exit

V.	Merge R1 files from run1 and run2 into one single fastq file and R2s into another single file. Example for merging R1 files from run1 and run2. Run the same script for R2 reads after changing names.

#!/bin/bash
#PBS -q batch
#PBS -l nodes=1:ppn=8
#PBS -l walltime=5:00:00
#PBS -N mergefiles
#PBS -m ea
#PBS -j oe
#PBS -M badhikari@uchc.edu

cd /projects/laubenbacher-lab/Aspergillosis/bandita/mac_may_analysis/runI
for r1 in *run1_R1_trimmed_P.fq.gz; do
        oth=${r1/run1_R1/run2_R1}
        RR1="/projects/laubenbacher-lab/Aspergillosis/bandita/mac_may_analysis/runI/"$r1
        RR2="/projects/laubenbacher-lab/Aspergillosis/bandita/mac_may_analysis/runII/"$oth
        output=$(echo $r1 |cut -d "_" -f 1)
        cat $RR1 $RR2 > "/projects/laubenbacher-lab/Aspergillosis/bandita/mac_may_analysis/merge_runI_runII/"${output}"_Pmerged_R1.fq.gz"
        #echo "/projects/laubenbacher-lab/Aspergillosis/bandita/mac_may_analysis/merge_runI_runII/"${output}"_Pmerged_R1.fq.gz"
done

VI.	Run fastqc again and once files are good, proceed to alignment process. There was no need to run trimmomatic again. The preprocessed data was aligned to the reference genome after this. 

VII.	STAR: Index the reference genome. 

#!/bin/bash
#PBS -q batch 
#PBS -l nodes=1:ppn=8
#PBS -l walltime=15:00:00
#PBS -N starindexhg75
#PBS -m ea
#PBS -j oe
#PBS -M badhikari@uchc.edu

module load STAR/2.5.3
cd /projects/laubenbacher-lab/Aspergillosis/bandita/GrCh38_Genome_v96
STAR --runMode genomeGenerate --genomeDir /projects/laubenbacher-lab/Aspergillosis/bandita/GrCh38_Genome_v96/star-genome75bp --genomeFastaFiles /projects/laubenbacher-lab/Aspergillosis/bandita/GrCh38_Genome_v96/Homo_sapiens.GRCh38.dna.primary_assembly.fa --sjdbGTFfile /projects/laubenbacher-lab/Aspergillosis/bandita/GrCh38_Genome_v96/Homo_sapiens.GRCh38.96.gtf --sjdbOverhang 75

VIII.	Run STAR alignment. 

cd /projects/laubenbacher-lab/Aspergillosis/bandita/mac_may_analysis/merge_runI_runII
for r1 in *_R1.fq.gz ;do
SAMPLE=$(echo $r1 | cut -d "_" -f 1)
r2=${r1/R1/R2}
echo "
#!/bin/bash
#PBS -q batch
#PBS -l nodes=1:ppn=8
#PBS -l walltime=30:00:00
#PBS -N star$(echo $r1 | cut -d "_" -f 1)
#PBS -l mem=50G
#PBS -m ea
#PBS -j oe
#PBS -e /projects/laubenbacher-lab/Aspergillosis/bandita/mac_may_analysis/merge_runI_runII/$(echo $r1 | cut -d "_" -f 1)star.err
#PBS -o /projects/laubenbacher-lab/Aspergillosis/bandita/mac_may_analysis/merge_runI_runII/$(echo $r1 | cut -d "_" -f 1)star.o 
#PBS -M badhikari@uchc.edu

module load STAR/2.5.3
cd /projects/laubenbacher-lab/Aspergillosis/bandita/mac_may_analysis/merge_runI_runII
STAR --runMode alignReads --readFilesCommand zcat --genomeDir /projects/laubenbacher-lab/Aspergillosis/bandita/GrCh38_Genome_v96/star-genome_hg_ercc_75 --readFilesIn "$r1" "$r2" --outSAMtype BAM SortedByCoordinate --twopassMode Basic --outSAMattrIHstart 0 --outReadsUnmapped Fastx --quantMode GeneCounts TranscriptomeSAM --outWigType wiggle --outFileNamePrefix ${SAMPLE}_STARout75_may_

exit
">/projects/laubenbacher-lab/Aspergillosis/bandita/mac_may_analysis/merge_runI_runII/star_$SAMPLE.sh

qsub /projects/laubenbacher-lab/Aspergillosis/bandita/mac_may_analysis/merge_runI_runII/star_$SAMPLE.sh
done
echo "jobs succesfully submitted"
exit

IX.	Ran qualimap to check  the alignment of the reads. 

#!/bin/bash
#PBS -q batch
#PBS -l nodes=1:ppn=8
#PBS -l walltime=72:00:00
#PBS -N qualimaprun1run2
#PBS -l mem=50G 
#PBS -m ea
#PBS -j oe
#PBS -M badhikari@uchc.edu

cd /projects/laubenbacher-lab/Aspergillosis/bandita/mac_may_analysis/merge_runI_runII

module load qualimap/2.2.1

for i in *Aligned.sortedByCoord.out.bam; do
qualimap rnaseq --java-mem-size=50G -bam /projects/laubenbacher-lab/Aspergillosis/bandita/mac_may_analysis/merge_runI_runII/$i --sequencing-protocol strand-specific-reverse strand-specific-reverse -gtf /projects/laubenbacher-lab/Aspergillosis/bandita/GrCh38_Genome_v96/Homo_sapiens.GRCh38.96.gtf -oc /projects/laubenbacher-lab/Aspergillosis/bandita/mac_may_analysis/merge_runI_runII/qualimap_mergedrun1run2/$i.counts -outdir /projects/laubenbacher-lab/Aspergillosis/bandita/mac_may_analysis/merge_runI_runII/qualimap_mergedrun1run2 -pe -outfile $i.qualimapreport.pdf
done

X.	Generate count matrix by combining counts (column 4 for stranded data) from all files. Python script "mergecounts_col4.py" uploaded on github.

XI.	Ran differential analysis with DESeq2, pairwise comparisons performed. R script "dse2_pairwise_control_treatment.Rmd" uploaded on github.

